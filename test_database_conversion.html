<!DOCTYPE html>
<html>
<head>
    <title>Test Database Sub Satuan Conversion</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .data { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Test Database Sub Satuan Conversion</h1>
    
    <div class="data">
        <h3>Sample Database Data:</h3>
        <p><strong>Ayam Potong (Kilogram - Rp 32,000):</strong></p>
        <ul>
            <li>Sub Satuan 1: Gram (1 Kilogram = 1.000 Gram) → Expected: Rp 32</li>
            <li>Sub Satuan 2: Potong (1 Kilogram = 4 Potong) → Expected: Rp 8.000</li>
            <li>Sub Satuan 3: Ons (1 Kilogram = 10 Ons) → Expected: Rp 3.200</li>
        </ul>
        
        <p><strong>Ayam Kampung (Ekor - Rp 45,000):</strong></p>
        <ul>
            <li>Sub Satuan 1: Kilogram (1 Ekor = 1,5 Kilogram) → Expected: Rp 30.000</li>
            <li>Sub Satuan 2: Potong (1 Ekor = 6 Potong) → Expected: Rp 7.500</li>
            <li>Sub Satuan 3: Gram (1 Ekor = 1.500 Gram) → Expected: Rp 30</li>
        </ul>
    </div>
    
    <div class="test">
        <h3>Test Conversions:</h3>
        <button onclick="testAyamPotong()">Test Ayam Potong Conversions</button>
        <button onclick="testAyamKampung()">Test Ayam Kampung Conversions</button>
        <button onclick="testPieces()">Test Pieces (No Sub Satuan)</button>
    </div>
    
    <div class="test">
        <h3>Test Results:</h3>
        <div id="testResults"></div>
    </div>

    <script>
        // Helper function to format numbers cleanly
        function formatNumberClean(num) {
            if (num === Math.floor(num)) {
                return Math.floor(num).toString();
            }
            return parseFloat(num.toFixed(4)).toString();
        }
        
        // Enhanced conversion system using database sub satuan data
        function getConversionFactor(fromUnit, toUnit, subSatuanData = []) {
            console.log('=== getConversionFactor ===');
            console.log('From:', fromUnit, 'To:', toUnit);
            console.log('Sub Satuan Data:', subSatuanData);
            
            const from = fromUnit.toLowerCase().trim();
            const to = toUnit.toLowerCase().trim();
            
            if (from === to) {
                return { factor: 1, formula: 'Satuan sama', operation: '×', value: '1' };
            }
            
            // Look for exact match in sub satuan data
            const matchingSub = subSatuanData.find(sub => 
                sub.nama.toLowerCase().trim() === to
            );
            
            if (matchingSub) {
                const factor = matchingSub.konversi / matchingSub.nilai;
                const konversiClean = formatNumberClean(matchingSub.konversi);
                const nilaiClean = formatNumberClean(matchingSub.nilai);
                
                console.log('Found matching sub satuan conversion:', {
                    factor: factor,
                    konversi: matchingSub.konversi,
                    nilai: matchingSub.nilai
                });
                
                return {
                    factor: factor,
                    formula: `Rumus: ${konversiClean} ${fromUnit} = ${nilaiClean} ${toUnit}`,
                    operation: factor > 1 ? '×' : '÷',
                    value: factor > 1 ? factor.toString() : (1/factor).toString()
                };
            }
            
            console.log('No matching sub satuan found');
            return { factor: null, formula: '', operation: '', value: '' };
        }
        
        function testConversion(itemName, fromUnit, toUnit, basePrice, subSatuanData, expectedPrice) {
            const result = getConversionFactor(fromUnit, toUnit, subSatuanData);
            const testResults = document.getElementById('testResults');
            
            if (result.factor !== null) {
                const convertedPrice = basePrice * result.factor;
                const isCorrect = Math.abs(convertedPrice - expectedPrice) < 1; // Allow 1 rupiah difference
                
                testResults.innerHTML += `
                    <div class="${isCorrect ? 'success' : 'error'}">
                        <strong>${itemName}: ${fromUnit} → ${toUnit}</strong><br>
                        ${result.formula}<br>
                        Rp ${basePrice.toLocaleString('id-ID')} × ${result.factor} = Rp ${Math.round(convertedPrice).toLocaleString('id-ID')}/${toUnit}<br>
                        Expected: Rp ${expectedPrice.toLocaleString('id-ID')} | ${isCorrect ? '✅ CORRECT' : '❌ WRONG'}
                    </div>
                `;
            } else {
                testResults.innerHTML += `
                    <div class="error">
                        <strong>${itemName}: ${fromUnit} → ${toUnit}</strong><br>
                        Konversi tidak tersedia (Expected: Rp ${expectedPrice.toLocaleString('id-ID')}) ❌ WRONG
                    </div>
                `;
            }
        }
        
        function testAyamPotong() {
            const subSatuanData = [
                { nama: 'Gram', konversi: 1, nilai: 1000 },
                { nama: 'Potong', konversi: 1, nilai: 4 },
                { nama: 'Ons', konversi: 1, nilai: 10 }
            ];
            
            testConversion('Ayam Potong', 'Kilogram', 'Gram', 32000, subSatuanData, 32);
            testConversion('Ayam Potong', 'Kilogram', 'Potong', 32000, subSatuanData, 8000);
            testConversion('Ayam Potong', 'Kilogram', 'Ons', 32000, subSatuanData, 3200);
        }
        
        function testAyamKampung() {
            const subSatuanData = [
                { nama: 'Kilogram', konversi: 1, nilai: 1.5 },
                { nama: 'Potong', konversi: 1, nilai: 6 },
                { nama: 'Gram', konversi: 1, nilai: 1500 }
            ];
            
            testConversion('Ayam Kampung', 'Ekor', 'Kilogram', 45000, subSatuanData, 30000);
            testConversion('Ayam Kampung', 'Ekor', 'Potong', 45000, subSatuanData, 7500);
            testConversion('Ayam Kampung', 'Ekor', 'Gram', 45000, subSatuanData, 30);
        }
        
        function testPieces() {
            const subSatuanData = []; // No sub satuan data
            
            testConversion('Test Item', 'Pieces', 'Buah', 2000, subSatuanData, 2000);
        }
    </script>
</body>
</html>