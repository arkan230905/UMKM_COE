<!DOCTYPE html>
<html>
<head>
    <title>Test Biaya Bahan Simple</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .console-log { background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Biaya Bahan Simple</h1>
        
        <div class="test-section">
            <h3>Test 1: JavaScript Functions</h3>
            <button class="btn btn-primary" onclick="testFunctions()">Test Functions</button>
            <div id="functionTest" class="mt-2"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 2: Conversion Display</h3>
            <div class="row">
                <div class="col-md-6">
                    <label>Bahan:</label>
                    <select id="testBahan" class="form-select" onchange="testConversion()">
                        <option value="">-- Pilih --</option>
                        <option value="ayam_kampung" data-harga="45000" data-satuan="Ekor" data-sub-satuan='[{"nama":"Kilogram","konversi":1,"nilai":1.5},{"nama":"Potong","konversi":1,"nilai":6},{"nama":"Gram","konversi":1,"nilai":1500}]'>Ayam Kampung - Rp 45,000/Ekor</option>
                        <option value="ayam_potong" data-harga="32000" data-satuan="Kilogram" data-sub-satuan='[{"nama":"Gram","konversi":1,"nilai":1000},{"nama":"Potong","konversi":1,"nilai":4},{"nama":"Ons","konversi":1,"nilai":10}]'>Ayam Potong - Rp 32,000/Kilogram</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Satuan:</label>
                    <select id="testSatuan" class="form-select" onchange="testConversion()">
                        <option value="">-- Pilih --</option>
                        <option value="Ekor">Ekor</option>
                        <option value="Kilogram">Kilogram</option>
                        <option value="Potong">Potong</option>
                        <option value="Gram">Gram</option>
                        <option value="Ons">Ons</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <label>Harga Satuan:</label>
                <div id="testHargaUtama" class="fw-bold">-</div>
                <div id="testHargaKonversi" class="mt-2 p-2 border rounded" style="min-height: 60px;">
                    Pilih bahan dan satuan untuk melihat konversi
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test 3: Subtotal Calculation</h3>
            <div class="row">
                <div class="col-md-3">
                    <label>Quantity:</label>
                    <input type="number" id="testQty" class="form-control" value="1" onchange="testSubtotal()">
                </div>
                <div class="col-md-9">
                    <label>Subtotal:</label>
                    <div id="testSubtotal" class="fw-bold fs-4 text-success">-</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Console Logs:</h3>
            <div id="consoleLogs" class="console-log"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const logContainer = document.getElementById('consoleLogs');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = args.join(' ') + '\n';
            logContainer.textContent += new Date().toLocaleTimeString() + ': ' + logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        // Helper functions (same as in main script)
        function formatClean(num) {
            return num === Math.floor(num) ? Math.floor(num).toString() : parseFloat(num.toFixed(4)).toString();
        }
        
        function formatRupiah(num) {
            return "Rp " + Math.round(num).toLocaleString("id-ID");
        }
        
        // Test functions
        function testFunctions() {
            const result = document.getElementById('functionTest');
            let tests = [];
            
            try {
                // Test formatClean
                tests.push(`formatClean(1.0000) = "${formatClean(1.0000)}" (expected: "1")`);
                tests.push(`formatClean(1.5) = "${formatClean(1.5)}" (expected: "1.5")`);
                
                // Test formatRupiah
                tests.push(`formatRupiah(45000) = "${formatRupiah(45000)}" (expected: "Rp 45,000")`);
                
                // Test JSON parsing
                const testData = '[{"nama":"Gram","konversi":1,"nilai":1000}]';
                const parsed = JSON.parse(testData);
                tests.push(`JSON.parse works: ${parsed.length} items`);
                
                result.innerHTML = '<div class="alert alert-success">‚úÖ All functions work:<br>' + tests.join('<br>') + '</div>';
                console.log("‚úÖ Function tests passed");
                
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + error.message + '</div>';
                console.log("‚ùå Function tests failed:", error);
            }
        }
        
        function testConversion() {
            console.log("üîÑ Testing conversion");
            
            const bahanSelect = document.getElementById('testBahan');
            const satuanSelect = document.getElementById('testSatuan');
            const hargaUtamaDiv = document.getElementById('testHargaUtama');
            const hargaKonversiDiv = document.getElementById('testHargaKonversi');
            
            const option = bahanSelect.options[bahanSelect.selectedIndex];
            const satuanDipilih = satuanSelect.value;
            
            if (!option || !option.value) {
                hargaUtamaDiv.textContent = '-';
                hargaKonversiDiv.innerHTML = 'Pilih bahan terlebih dahulu';
                return;
            }
            
            const hargaUtama = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || 'unit';
            const subSatuanData = JSON.parse(option.dataset.subSatuan || '[]');
            
            console.log("üìã Conversion data:", {
                harga: hargaUtama,
                satuanUtama: satuanUtama,
                satuanDipilih: satuanDipilih,
                subSatuan: subSatuanData.length
            });
            
            // Update harga utama
            hargaUtamaDiv.textContent = formatRupiah(hargaUtama) + '/' + satuanUtama;
            
            if (!satuanDipilih) {
                hargaKonversiDiv.innerHTML = 'Pilih satuan untuk melihat konversi';
                return;
            }
            
            // Use same logic as main script
            if (subSatuanData.length > 0) {
                console.log("‚úÖ Using database sub satuan");
                
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === satuanDipilih.toLowerCase().trim()
                );
                
                if (match) {
                    const hargaKonversi = (hargaUtama * match.konversi) / match.nilai;
                    const konversiClean = formatClean(match.konversi);
                    const nilaiClean = formatClean(match.nilai);
                    
                    console.log("üéØ Found match:", match);
                    
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-info mb-1">
                            <strong>${formatRupiah(hargaKonversi)}/${satuanDipilih}</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.9rem;">
                            <div><strong>üìä Rumus:</strong></div>
                            <div>‚Ä¢ ${konversiClean} ${satuanUtama} = ${nilaiClean} ${satuanDipilih}</div>
                            <div>‚Ä¢ ${formatRupiah(hargaUtama)} √ó ${konversiClean} √∑ ${nilaiClean}</div>
                            <div class="text-success">‚Ä¢ <strong>${formatRupiah(hargaKonversi)}</strong></div>
                        </div>
                    `;
                } else if (satuanDipilih === satuanUtama) {
                    console.log("üìã Showing all conversions");
                    
                    let html = '<div class="text-success mb-1"><strong>Konversi Tersedia:</strong></div>';
                    
                    subSatuanData.forEach(sub => {
                        const hargaKonversi = (hargaUtama * sub.konversi) / sub.nilai;
                        const konversiClean = formatClean(sub.konversi);
                        const nilaiClean = formatClean(sub.nilai);
                        
                        html += `
                            <div class="border-start border-info ps-2 mb-1" style="font-size: 0.9rem;">
                                <div class="text-info"><strong>${formatRupiah(hargaKonversi)}/${sub.nama}</strong></div>
                                <div class="text-muted">${konversiClean} ${satuanUtama} = ${nilaiClean} ${sub.nama}</div>
                            </div>
                        `;
                    });
                    
                    hargaKonversiDiv.innerHTML = html;
                } else {
                    hargaKonversiDiv.innerHTML = '<div class="text-warning">Konversi tidak ditemukan</div>';
                }
            } else {
                if (satuanDipilih === satuanUtama) {
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-success">
                            <strong>${formatRupiah(hargaUtama)}/${satuanUtama}</strong>
                        </div>
                        <small class="text-muted">Satuan sama</small>
                    `;
                } else {
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-warning">Konversi tidak tersedia</div>
                        <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                    `;
                }
            }
            
            // Test subtotal
            testSubtotal();
        }
        
        function testSubtotal() {
            console.log("üßÆ Testing subtotal");
            
            const bahanSelect = document.getElementById('testBahan');
            const satuanSelect = document.getElementById('testSatuan');
            const qtyInput = document.getElementById('testQty');
            const subtotalDiv = document.getElementById('testSubtotal');
            
            const option = bahanSelect.options[bahanSelect.selectedIndex];
            const satuanDipilih = satuanSelect.value;
            const qty = parseFloat(qtyInput.value) || 0;
            
            if (!option || !option.value || !satuanDipilih || qty <= 0) {
                subtotalDiv.textContent = '-';
                return;
            }
            
            const harga = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || 'unit';
            const subSatuanData = JSON.parse(option.dataset.subSatuan || '[]');
            
            let subtotal = harga * qty;
            
            // Apply conversion if different units
            if (satuanUtama !== satuanDipilih) {
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === satuanDipilih.toLowerCase().trim()
                );
                
                if (match) {
                    const factor = match.konversi / match.nilai;
                    subtotal = (harga * factor) * qty;
                    console.log("üîÑ Applied conversion factor:", factor);
                }
            }
            
            subtotalDiv.textContent = formatRupiah(subtotal);
            console.log("‚úÖ Subtotal calculated:", subtotal);
        }
        
        function clearLogs() {
            document.getElementById('consoleLogs').textContent = '';
        }
        
        // Auto-run function test on load
        setTimeout(() => {
            testFunctions();
            console.log("üéâ Test page loaded successfully");
        }, 500);
    </script>
</body>
</html>