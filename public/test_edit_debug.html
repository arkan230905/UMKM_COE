<!DOCTYPE html>
<html>
<head>
    <title>Test Edit Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .debug-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .console-log { background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Edit Debug</h1>
        <div class="alert alert-info">
            <strong>Debug untuk Edit Page Issues:</strong><br>
            1. Data existing tidak menampilkan konversi<br>
            2. Total tidak terhitung dengan benar<br>
            3. Subtotal tidak update
        </div>
        
        <div class="debug-section">
            <h3>Simulasi Data Existing</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Bahan Baku Row (Existing)</h5>
                    <div class="mb-2">
                        <label>Bahan:</label>
                        <select id="existingBB" class="form-select bahan-baku-select">
                            <option value="">-- Pilih --</option>
                            <option value="3" 
                                    data-harga="45000" 
                                    data-satuan="Ekor" 
                                    data-sub-satuan='[{"id":2,"nama":"Kilogram","konversi":"1.0000","nilai":"1.5000"},{"id":7,"nama":"Potong","konversi":"1.0000","nilai":"6.0000"},{"id":4,"nama":"Gram","konversi":"1.0000","nilai":"1500.0000"}]'
                                    selected>
                                Ayam Kampung - Rp 45,000/Ekor
                            </option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Quantity:</label>
                        <input type="number" id="existingBBQty" class="form-control qty-input" value="1">
                    </div>
                    <div class="mb-2">
                        <label>Satuan:</label>
                        <select id="existingBBSatuan" class="form-select satuan-select">
                            <option value="Ekor" selected>Ekor</option>
                            <option value="Potong">Potong</option>
                            <option value="Kilogram">Kilogram</option>
                            <option value="Gram">Gram</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Harga Display:</label>
                        <div class="harga-display">
                            <div class="harga-utama">Rp 45,000</div>
                            <div class="harga-konversi mt-1" style="font-size: 0.75rem; color: #666;"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label>Subtotal:</label>
                        <div class="subtotal-display fw-bold">Rp 45,000</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5>Bahan Pendukung Row (Existing)</h5>
                    <div class="mb-2">
                        <label>Bahan:</label>
                        <select id="existingBP" class="form-select bahan-pendukung-select">
                            <option value="">-- Pilih --</option>
                            <option value="3" 
                                    data-harga="28000" 
                                    data-satuan="Kilogram" 
                                    data-sub-satuan='[{"id":4,"nama":"Gram","konversi":"1.0000","nilai":"1000.0000"},{"id":6,"nama":"Ons","konversi":"1.0000","nilai":"10.0000"},{"id":8,"nama":"Siung","konversi":"1.0000","nilai":"250.0000"}]'
                                    selected>
                                Bawang Putih - Rp 28,000/Kilogram
                            </option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Quantity:</label>
                        <input type="number" id="existingBPQty" class="form-control qty-input" value="1">
                    </div>
                    <div class="mb-2">
                        <label>Satuan:</label>
                        <select id="existingBPSatuan" class="form-select satuan-select">
                            <option value="Kilogram" selected>Kilogram</option>
                            <option value="Gram">Gram</option>
                            <option value="Ons">Ons</option>
                            <option value="Siung">Siung</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Harga Display:</label>
                        <div class="harga-display">
                            <div class="harga-utama">Rp 28,000</div>
                            <div class="harga-konversi mt-1" style="font-size: 0.75rem; color: #666;"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label>Subtotal:</label>
                        <div class="subtotal-display fw-bold">Rp 28,000</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-primary" onclick="initializeExistingData()">üîÑ Initialize Existing Data</button>
                <button class="btn btn-warning" onclick="testConversions()">üß™ Test Conversions</button>
                <button class="btn btn-success" onclick="calculateTestTotals()">üßÆ Calculate Totals</button>
            </div>
            
            <div class="mt-3">
                <h5>Totals:</h5>
                <div>Total BB: <span id="totalBB">Rp 0</span></div>
                <div>Total BP: <span id="totalBP">Rp 0</span></div>
                <div>Total Keseluruhan: <span id="totalAll">Rp 0</span></div>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>Console Logs:</h3>
            <div id="consoleLogs" class="console-log"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const logContainer = document.getElementById('consoleLogs');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = args.join(' ') + '\n';
            logContainer.textContent += new Date().toLocaleTimeString() + ': ' + logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        // Same functions as edit page
        function formatClean(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            return num === Math.floor(num) ? Math.floor(num).toString() : parseFloat(num.toFixed(4)).toString();
        }
        
        function formatRupiah(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            return "Rp " + Math.round(num).toLocaleString("id-ID");
        }
        
        function updateConversionDisplay(row, option) {
            console.log("üìä updateConversionDisplay called");
            
            const hargaKonversiDiv = row.querySelector(".harga-konversi");
            const satuanSelect = row.querySelector(".satuan-select");
            
            if (!hargaKonversiDiv || !option || !satuanSelect) {
                console.log("‚ùå Missing elements");
                return;
            }
            
            const hargaUtama = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || "unit";
            const satuanDipilih = satuanSelect.value;
            
            let subSatuanData = [];
            try {
                const rawData = option.dataset.subSatuan || "[]";
                subSatuanData = JSON.parse(rawData);
                console.log("üìã Parsed sub satuan data:", subSatuanData);
            } catch (e) {
                console.error("‚ùå Error parsing sub satuan data:", e);
                subSatuanData = [];
            }
            
            console.log("üìã Data:", {
                harga: hargaUtama,
                satuanUtama: satuanUtama,
                satuanDipilih: satuanDipilih,
                subSatuanCount: subSatuanData.length
            });
            
            if (!satuanDipilih) {
                hargaKonversiDiv.innerHTML = '<small class="text-muted">Pilih satuan untuk konversi</small>';
                return;
            }
            
            if (subSatuanData.length > 0) {
                console.log("‚úÖ Using database sub satuan");
                
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === satuanDipilih.toLowerCase().trim()
                );
                
                if (match) {
                    const konversi = parseFloat(match.konversi) || 1;
                    const nilai = parseFloat(match.nilai) || 1;
                    const hargaKonversi = (hargaUtama * konversi) / nilai;
                    const konversiClean = formatClean(konversi);
                    const nilaiClean = formatClean(nilai);
                    
                    console.log("üéØ Found match:", {
                        match: match,
                        konversi: konversi,
                        nilai: nilai,
                        hargaKonversi: hargaKonversi
                    });
                    
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-info mb-2">
                            <strong>${formatRupiah(hargaKonversi)}/${satuanDipilih}</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.85rem; line-height: 1.3;">
                            <div class="fw-bold text-primary mb-1">üìä Rumus:</div>
                            <div>‚Ä¢ ${konversiClean} ${satuanUtama} = ${nilaiClean} ${satuanDipilih}</div>
                            <div>‚Ä¢ ${formatRupiah(hargaUtama)} √ó ${konversiClean} √∑ ${nilaiClean}</div>
                            <div class="text-success fw-bold">‚Ä¢ = ${formatRupiah(hargaKonversi)}</div>
                        </div>
                    `;
                    return;
                }
                
                if (satuanDipilih === satuanUtama) {
                    console.log("üìã Same unit - showing all conversions");
                    
                    let html = '<div class="text-success mb-2"><strong>Satuan sama, tidak perlu konversi</strong></div>';
                    html += '<div class="text-muted mb-2"><strong>Konversi Tersedia:</strong></div>';
                    
                    subSatuanData.forEach(sub => {
                        const konversi = parseFloat(sub.konversi) || 1;
                        const nilai = parseFloat(sub.nilai) || 1;
                        const hargaKonversi = (hargaUtama * konversi) / nilai;
                        const konversiClean = formatClean(konversi);
                        const nilaiClean = formatClean(nilai);
                        
                        html += `
                            <div class="border-start border-info ps-2 mb-1" style="font-size: 0.8rem;">
                                <div class="text-info"><strong>${formatRupiah(hargaKonversi)}/${sub.nama}</strong></div>
                                <div class="text-muted">${konversiClean} ${satuanUtama} = ${nilaiClean} ${sub.nama}</div>
                            </div>
                        `;
                    });
                    
                    hargaKonversiDiv.innerHTML = html;
                    return;
                } else {
                    console.log("‚ö†Ô∏è No conversion match found");
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-warning mb-1">Konversi tidak ditemukan</div>
                        <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                    `;
                    return;
                }
            }
            
            if (satuanDipilih === satuanUtama) {
                hargaKonversiDiv.innerHTML = `
                    <div class="text-success mb-1">
                        <strong>${formatRupiah(hargaUtama)}/${satuanUtama}</strong>
                    </div>
                    <small class="text-muted">Satuan sama, tidak perlu konversi</small>
                `;
            } else {
                hargaKonversiDiv.innerHTML = `
                    <div class="text-warning">Konversi tidak tersedia</div>
                    <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                `;
            }
        }
        
        function getConversionFactor(fromUnit, toUnit, subSatuanData = []) {
            if (fromUnit.toLowerCase() === toUnit.toLowerCase()) {
                return 1;
            }
            
            if (subSatuanData.length > 0) {
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === toUnit.toLowerCase().trim()
                );
                
                if (match) {
                    const konversi = parseFloat(match.konversi) || 1;
                    const nilai = parseFloat(match.nilai) || 1;
                    return konversi / nilai;
                }
            }
            
            return 1;
        }
        
        function calculateRowSubtotal(row) {
            console.log("üßÆ calculateRowSubtotal called");
            
            const bahanSelect = row.querySelector(".bahan-baku-select, .bahan-pendukung-select");
            const qtyInput = row.querySelector(".qty-input");
            const satuanSelect = row.querySelector(".satuan-select");
            const subtotalDisplay = row.querySelector(".subtotal-display");
            
            if (!bahanSelect || !qtyInput || !satuanSelect || !subtotalDisplay) {
                console.log("‚ùå Missing elements for calculation");
                return;
            }
            
            const option = bahanSelect.options[bahanSelect.selectedIndex];
            if (!option || !option.value) {
                subtotalDisplay.innerHTML = "-";
                return;
            }
            
            const harga = parseFloat(option.dataset.harga) || 0;
            const qty = parseFloat(qtyInput.value) || 0;
            const satuanUtama = option.dataset.satuan || "unit";
            const satuanDipilih = satuanSelect.value;
            
            let subSatuanData = [];
            try {
                subSatuanData = JSON.parse(option.dataset.subSatuan || "[]");
            } catch (e) {
                console.error("‚ùå Error parsing sub satuan for calculation:", e);
                subSatuanData = [];
            }
            
            console.log("üí∞ Calculation data:", {
                bahan: option.text,
                harga: harga,
                qty: qty,
                satuanUtama: satuanUtama,
                satuanDipilih: satuanDipilih,
                subSatuanCount: subSatuanData.length
            });
            
            if (qty <= 0 || !satuanDipilih) {
                subtotalDisplay.innerHTML = "-";
                return;
            }
            
            let subtotal = harga * qty;
            
            if (satuanUtama !== satuanDipilih) {
                const factor = getConversionFactor(satuanUtama, satuanDipilih, subSatuanData);
                subtotal = (harga * factor) * qty;
                console.log("üîÑ Applied conversion factor:", factor, "New subtotal:", subtotal);
            }
            
            subtotalDisplay.innerHTML = `<strong class="text-success">${formatRupiah(subtotal)}</strong>`;
            console.log("‚úÖ Subtotal updated:", subtotal, "for", option.text);
        }
        
        // Test functions
        function initializeExistingData() {
            console.log("üîÑ Initializing existing data...");
            
            // Get existing rows
            const bbRow = document.querySelector('#existingBB').closest('.col-md-6');
            const bpRow = document.querySelector('#existingBP').closest('.col-md-6');
            
            // Process BB
            const bbSelect = document.getElementById('existingBB');
            if (bbSelect.value) {
                const option = bbSelect.options[bbSelect.selectedIndex];
                updateConversionDisplay(bbRow, option);
                calculateRowSubtotal(bbRow);
            }
            
            // Process BP
            const bpSelect = document.getElementById('existingBP');
            if (bpSelect.value) {
                const option = bpSelect.options[bpSelect.selectedIndex];
                updateConversionDisplay(bpRow, option);
                calculateRowSubtotal(bpRow);
            }
            
            console.log("‚úÖ Existing data initialized");
        }
        
        function testConversions() {
            console.log("üß™ Testing conversions...");
            
            // Test BB conversion
            const bbSatuan = document.getElementById('existingBBSatuan');
            bbSatuan.value = 'Potong';
            bbSatuan.dispatchEvent(new Event('change'));
            
            // Test BP conversion  
            const bpSatuan = document.getElementById('existingBPSatuan');
            bpSatuan.value = 'Gram';
            bpSatuan.dispatchEvent(new Event('change'));
            
            console.log("‚úÖ Conversions tested");
        }
        
        function calculateTestTotals() {
            console.log("üßÆ Calculating test totals...");
            
            const bbSubtotal = document.querySelector('#existingBB').closest('.col-md-6').querySelector('.subtotal-display').textContent;
            const bpSubtotal = document.querySelector('#existingBP').closest('.col-md-6').querySelector('.subtotal-display').textContent;
            
            const bbAmount = parseFloat(bbSubtotal.replace(/[^\d]/g, '')) || 0;
            const bpAmount = parseFloat(bpSubtotal.replace(/[^\d]/g, '')) || 0;
            const total = bbAmount + bpAmount;
            
            document.getElementById('totalBB').textContent = formatRupiah(bbAmount);
            document.getElementById('totalBP').textContent = formatRupiah(bpAmount);
            document.getElementById('totalAll').textContent = formatRupiah(total);
            
            console.log("‚úÖ Test totals calculated:", { bb: bbAmount, bp: bpAmount, total: total });
        }
        
        function clearLogs() {
            document.getElementById('consoleLogs').textContent = '';
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // BB events
            document.getElementById('existingBBSatuan').addEventListener('change', function() {
                const bbRow = document.querySelector('#existingBB').closest('.col-md-6');
                const bbSelect = document.getElementById('existingBB');
                const option = bbSelect.options[bbSelect.selectedIndex];
                updateConversionDisplay(bbRow, option);
                calculateRowSubtotal(bbRow);
            });
            
            document.getElementById('existingBBQty').addEventListener('input', function() {
                const bbRow = document.querySelector('#existingBB').closest('.col-md-6');
                calculateRowSubtotal(bbRow);
            });
            
            // BP events
            document.getElementById('existingBPSatuan').addEventListener('change', function() {
                const bpRow = document.querySelector('#existingBP').closest('.col-md-6');
                const bpSelect = document.getElementById('existingBP');
                const option = bpSelect.options[bpSelect.selectedIndex];
                updateConversionDisplay(bpRow, option);
                calculateRowSubtotal(bpRow);
            });
            
            document.getElementById('existingBPQty').addEventListener('input', function() {
                const bpRow = document.querySelector('#existingBP').closest('.col-md-6');
                calculateRowSubtotal(bpRow);
            });
            
            // Auto initialize
            setTimeout(initializeExistingData, 500);
            
            console.log("üéâ Test page loaded");
        });
    </script>
</body>
</html>