<!DOCTYPE html>
<html>
<head>
    <title>Test Biaya Bahan FIXED VERSION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .console-log { background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .harga-konversi { min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Biaya Bahan FIXED VERSION</h1>
        <div class="alert alert-info">
            <strong>üéØ Testing Goals:</strong><br>
            1. Conversion formulas must display with clean numbers (1 instead of 1.0000)<br>
            2. Show calculation steps like "Rumus: 1 Ekor = 6 Potong, Rp 45,000 √ó 1 √∑ 6 = Rp 7,500"<br>
            3. Subtotal calculations must work correctly with conversions<br>
            4. Use database sub satuan data as primary reference
        </div>
        
        <div class="test-section">
            <h3>Test 1: JavaScript Functions</h3>
            <button class="btn btn-primary" onclick="testFunctions()">Test Functions</button>
            <div id="functionTest" class="mt-2"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 2: Conversion Display (Database Sub Satuan)</h3>
            <div class="row">
                <div class="col-md-4">
                    <label>Bahan:</label>
                    <select id="testBahan" class="form-select" onchange="testConversion()">
                        <option value="">-- Pilih --</option>
                        <option value="ayam_kampung" 
                                data-harga="45000" 
                                data-satuan="Ekor" 
                                data-sub-satuan='[{"id":2,"nama":"Kilogram","konversi":"1.0000","nilai":"1.5000"},{"id":7,"nama":"Potong","konversi":"1.0000","nilai":"6.0000"},{"id":4,"nama":"Gram","konversi":"1.0000","nilai":"1500.0000"}]'>
                            Ayam Kampung - Rp 45,000/Ekor
                        </option>
                        <option value="ayam_potong" 
                                data-harga="32000" 
                                data-satuan="Kilogram" 
                                data-sub-satuan='[{"id":4,"nama":"Gram","konversi":"1.0000","nilai":"1000.0000"},{"id":7,"nama":"Potong","konversi":"1.0000","nilai":"4.0000"},{"id":6,"nama":"Ons","konversi":"1.0000","nilai":"10.0000"}]'>
                            Ayam Potong - Rp 32,000/Kilogram
                        </option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Satuan:</label>
                    <select id="testSatuan" class="form-select satuan-select" onchange="testConversion()">
                        <option value="">-- Pilih --</option>
                        <option value="Ekor">Ekor</option>
                        <option value="Kilogram">Kilogram</option>
                        <option value="Potong">Potong</option>
                        <option value="Gram">Gram</option>
                        <option value="Ons">Ons</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Quantity:</label>
                    <input type="number" id="testQty" class="form-control qty-input" value="1" onchange="testSubtotal()">
                </div>
            </div>
            <div class="mt-3">
                <label>Harga Satuan:</label>
                <div id="testHargaUtama" class="harga-utama fw-bold">-</div>
                <div id="testHargaKonversi" class="harga-konversi mt-2">
                    Pilih bahan dan satuan untuk melihat konversi
                </div>
            </div>
            <div class="mt-3">
                <label>Subtotal:</label>
                <div id="testSubtotal" class="subtotal-display fw-bold fs-4 text-success">-</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test 3: Specific Conversion Cases</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Case 1: Ayam Kampung (Ekor ‚Üí Potong)</h5>
                    <button class="btn btn-info btn-sm" onclick="testCase1()">Test Case 1</button>
                    <div id="case1Result" class="mt-2 p-2 border rounded" style="min-height: 60px;"></div>
                </div>
                <div class="col-md-6">
                    <h5>Case 2: Ayam Potong (Kilogram ‚Üí Gram)</h5>
                    <button class="btn btn-info btn-sm" onclick="testCase2()">Test Case 2</button>
                    <div id="case2Result" class="mt-2 p-2 border rounded" style="min-height: 60px;"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Console Logs:</h3>
            <div id="consoleLogs" class="console-log"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const logContainer = document.getElementById('consoleLogs');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = args.join(' ') + '\n';
            logContainer.textContent += new Date().toLocaleTimeString() + ': ' + logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        // Helper functions (FIXED VERSION)
        function formatClean(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            return num === Math.floor(num) ? Math.floor(num).toString() : parseFloat(num.toFixed(4)).toString();
        }
        
        function formatRupiah(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            return "Rp " + Math.round(num).toLocaleString("id-ID");
        }
        
        // MAIN FUNCTION: Update conversion display (FIXED VERSION)
        function updateConversionDisplay(row, option) {
            console.log("üìä updateConversionDisplay called");
            
            const hargaKonversiDiv = row.querySelector(".harga-konversi") || document.getElementById('testHargaKonversi');
            const satuanSelect = row.querySelector(".satuan-select") || document.getElementById('testSatuan');
            
            if (!hargaKonversiDiv || !option || !satuanSelect) {
                console.log("‚ùå Missing elements");
                return;
            }
            
            const hargaUtama = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || "unit";
            const satuanDipilih = satuanSelect.value;
            
            // Parse sub satuan data with error handling
            let subSatuanData = [];
            try {
                const rawData = option.dataset.subSatuan || "[]";
                subSatuanData = JSON.parse(rawData);
                console.log("üìã Parsed sub satuan data:", subSatuanData);
            } catch (e) {
                console.error("‚ùå Error parsing sub satuan data:", e);
                subSatuanData = [];
            }
            
            console.log("üìã Data:", {
                harga: hargaUtama,
                satuanUtama: satuanUtama,
                satuanDipilih: satuanDipilih,
                subSatuanCount: subSatuanData.length
            });
            
            if (!satuanDipilih) {
                hargaKonversiDiv.innerHTML = '<small class="text-muted">Pilih satuan untuk konversi</small>';
                return;
            }
            
            // Use database sub satuan
            if (subSatuanData.length > 0) {
                console.log("‚úÖ Using database sub satuan");
                
                // Find exact match
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === satuanDipilih.toLowerCase().trim()
                );
                
                if (match) {
                    // Specific conversion - FIXED CALCULATION
                    const konversi = parseFloat(match.konversi) || 1;
                    const nilai = parseFloat(match.nilai) || 1;
                    const hargaKonversi = (hargaUtama * konversi) / nilai;
                    const konversiClean = formatClean(konversi);
                    const nilaiClean = formatClean(nilai);
                    
                    console.log("üéØ Found match:", {
                        match: match,
                        konversi: konversi,
                        nilai: nilai,
                        hargaKonversi: hargaKonversi
                    });
                    
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-info mb-2">
                            <strong>${formatRupiah(hargaKonversi)}/${satuanDipilih}</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.85rem; line-height: 1.3;">
                            <div class="fw-bold text-primary mb-1">üìä Rumus:</div>
                            <div>‚Ä¢ ${konversiClean} ${satuanUtama} = ${nilaiClean} ${satuanDipilih}</div>
                            <div>‚Ä¢ ${formatRupiah(hargaUtama)} √ó ${konversiClean} √∑ ${nilaiClean}</div>
                            <div class="text-success fw-bold">‚Ä¢ = ${formatRupiah(hargaKonversi)}</div>
                        </div>
                    `;
                    return;
                }
                
                // Show all conversions if same unit
                if (satuanDipilih === satuanUtama) {
                    console.log("üìã Same unit - showing all conversions");
                    
                    let html = '<div class="text-success mb-2"><strong>Satuan sama, tidak perlu konversi</strong></div>';
                    html += '<div class="text-muted mb-2"><strong>Konversi Tersedia:</strong></div>';
                    
                    subSatuanData.forEach(sub => {
                        const konversi = parseFloat(sub.konversi) || 1;
                        const nilai = parseFloat(sub.nilai) || 1;
                        const hargaKonversi = (hargaUtama * konversi) / nilai;
                        const konversiClean = formatClean(konversi);
                        const nilaiClean = formatClean(nilai);
                        
                        html += `
                            <div class="border-start border-info ps-2 mb-1" style="font-size: 0.8rem;">
                                <div class="text-info"><strong>${formatRupiah(hargaKonversi)}/${sub.nama}</strong></div>
                                <div class="text-muted">${konversiClean} ${satuanUtama} = ${nilaiClean} ${sub.nama}</div>
                            </div>
                        `;
                    });
                    
                    hargaKonversiDiv.innerHTML = html;
                    return;
                } else {
                    // No match found
                    console.log("‚ö†Ô∏è No conversion match found");
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-warning mb-1">Konversi tidak ditemukan</div>
                        <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                    `;
                    return;
                }
            }
            
            // No sub satuan data
            if (satuanDipilih === satuanUtama) {
                hargaKonversiDiv.innerHTML = `
                    <div class="text-success mb-1">
                        <strong>${formatRupiah(hargaUtama)}/${satuanUtama}</strong>
                    </div>
                    <small class="text-muted">Satuan sama, tidak perlu konversi</small>
                `;
            } else {
                hargaKonversiDiv.innerHTML = `
                    <div class="text-warning">Konversi tidak tersedia</div>
                    <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                `;
            }
        }
        
        // Get conversion factor for calculations
        function getConversionFactor(fromUnit, toUnit, subSatuanData = []) {
            if (fromUnit.toLowerCase() === toUnit.toLowerCase()) {
                return 1;
            }
            
            if (subSatuanData.length > 0) {
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === toUnit.toLowerCase().trim()
                );
                
                if (match) {
                    const konversi = parseFloat(match.konversi) || 1;
                    const nilai = parseFloat(match.nilai) || 1;
                    return konversi / nilai;
                }
            }
            
            return 1; // Default fallback
        }
        
        // Calculate subtotal
        function calculateSubtotal(harga, qty, satuanUtama, satuanDipilih, subSatuanData) {
            let subtotal = harga * qty;
            
            // Apply conversion if different units
            if (satuanUtama !== satuanDipilih) {
                const factor = getConversionFactor(satuanUtama, satuanDipilih, subSatuanData);
                subtotal = (harga * factor) * qty;
                console.log("üîÑ Applied conversion factor:", factor, "New subtotal:", subtotal);
            }
            
            return subtotal;
        }
        
        // Test functions
        function testFunctions() {
            const result = document.getElementById('functionTest');
            let tests = [];
            
            try {
                // Test formatClean
                tests.push(`formatClean("1.0000") = "${formatClean("1.0000")}" (expected: "1")`);
                tests.push(`formatClean(1.5) = "${formatClean(1.5)}" (expected: "1.5")`);
                
                // Test formatRupiah
                tests.push(`formatRupiah(45000) = "${formatRupiah(45000)}" (expected: "Rp 45,000")`);
                tests.push(`formatRupiah("32000") = "${formatRupiah("32000")}" (expected: "Rp 32,000")`);
                
                // Test JSON parsing
                const testData = '[{"nama":"Gram","konversi":"1.0000","nilai":"1000.0000"}]';
                const parsed = JSON.parse(testData);
                tests.push(`JSON.parse works: ${parsed.length} items`);
                
                // Test conversion factor
                const factor = getConversionFactor("Ekor", "Potong", [{"nama":"Potong","konversi":"1.0000","nilai":"6.0000"}]);
                tests.push(`getConversionFactor(Ekor‚ÜíPotong) = ${factor} (expected: 0.16667)`);
                
                result.innerHTML = '<div class="alert alert-success">‚úÖ All functions work:<br>' + tests.join('<br>') + '</div>';
                console.log("‚úÖ Function tests passed");
                
            } catch (error) {
                result.innerHTML = '<div class="alert alert-danger">‚ùå Error: ' + error.message + '</div>';
                console.log("‚ùå Function tests failed:", error);
            }
        }
        
        function testConversion() {
            console.log("üîÑ Testing conversion");
            
            const bahanSelect = document.getElementById('testBahan');
            const satuanSelect = document.getElementById('testSatuan');
            const hargaUtamaDiv = document.getElementById('testHargaUtama');
            
            const option = bahanSelect.options[bahanSelect.selectedIndex];
            const satuanDipilih = satuanSelect.value;
            
            if (!option || !option.value) {
                hargaUtamaDiv.textContent = '-';
                document.getElementById('testHargaKonversi').innerHTML = 'Pilih bahan terlebih dahulu';
                return;
            }
            
            const hargaUtama = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || 'unit';
            
            // Update harga utama
            hargaUtamaDiv.textContent = formatRupiah(hargaUtama) + '/' + satuanUtama;
            
            // Create mock row for testing
            const mockRow = {
                querySelector: (selector) => {
                    if (selector === '.harga-konversi') return document.getElementById('testHargaKonversi');
                    if (selector === '.satuan-select') return document.getElementById('testSatuan');
                    return null;
                }
            };
            
            // Use same logic as main script
            updateConversionDisplay(mockRow, option);
            
            // Test subtotal
            testSubtotal();
        }
        
        function testSubtotal() {
            console.log("üßÆ Testing subtotal");
            
            const bahanSelect = document.getElementById('testBahan');
            const satuanSelect = document.getElementById('testSatuan');
            const qtyInput = document.getElementById('testQty');
            const subtotalDiv = document.getElementById('testSubtotal');
            
            const option = bahanSelect.options[bahanSelect.selectedIndex];
            const satuanDipilih = satuanSelect.value;
            const qty = parseFloat(qtyInput.value) || 0;
            
            if (!option || !option.value || !satuanDipilih || qty <= 0) {
                subtotalDiv.textContent = '-';
                return;
            }
            
            const harga = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || 'unit';
            
            // Parse sub satuan data
            let subSatuanData = [];
            try {
                subSatuanData = JSON.parse(option.dataset.subSatuan || '[]');
            } catch (e) {
                console.error("‚ùå Error parsing sub satuan for calculation:", e);
                subSatuanData = [];
            }
            
            const subtotal = calculateSubtotal(harga, qty, satuanUtama, satuanDipilih, subSatuanData);
            
            subtotalDiv.innerHTML = `<strong class="text-success">${formatRupiah(subtotal)}</strong>`;
            console.log("‚úÖ Subtotal calculated:", subtotal);
        }
        
        function testCase1() {
            // Ayam Kampung: Ekor ‚Üí Potong
            console.log("üß™ Testing Case 1: Ayam Kampung (Ekor ‚Üí Potong)");
            
            const bahanSelect = document.getElementById('testBahan');
            const satuanSelect = document.getElementById('testSatuan');
            const qtyInput = document.getElementById('testQty');
            
            // Set values
            bahanSelect.value = 'ayam_kampung';
            satuanSelect.value = 'Potong';
            qtyInput.value = '1';
            
            // Trigger conversion
            testConversion();
            
            // Expected: 1 Ekor = 6 Potong, Rp 45,000 √∑ 6 = Rp 7,500
            const expected = 45000 / 6;
            document.getElementById('case1Result').innerHTML = `
                <div class="text-info"><strong>Expected Result:</strong></div>
                <div>1 Ekor = 6 Potong</div>
                <div>Rp 45,000 √∑ 6 = Rp ${expected.toLocaleString('id-ID')}</div>
                <div class="text-success mt-2"><strong>Check conversion display above ‚Üë</strong></div>
            `;
        }
        
        function testCase2() {
            // Ayam Potong: Kilogram ‚Üí Gram
            console.log("üß™ Testing Case 2: Ayam Potong (Kilogram ‚Üí Gram)");
            
            const bahanSelect = document.getElementById('testBahan');
            const satuanSelect = document.getElementById('testSatuan');
            const qtyInput = document.getElementById('testQty');
            
            // Set values
            bahanSelect.value = 'ayam_potong';
            satuanSelect.value = 'Gram';
            qtyInput.value = '1';
            
            // Trigger conversion
            testConversion();
            
            // Expected: 1 Kilogram = 1000 Gram, Rp 32,000 √∑ 1000 = Rp 32
            const expected = 32000 / 1000;
            document.getElementById('case2Result').innerHTML = `
                <div class="text-info"><strong>Expected Result:</strong></div>
                <div>1 Kilogram = 1000 Gram</div>
                <div>Rp 32,000 √∑ 1000 = Rp ${expected.toLocaleString('id-ID')}</div>
                <div class="text-success mt-2"><strong>Check conversion display above ‚Üë</strong></div>
            `;
        }
        
        function clearLogs() {
            document.getElementById('consoleLogs').textContent = '';
        }
        
        // Auto-run function test on load
        setTimeout(() => {
            testFunctions();
            console.log("üéâ FIXED Test page loaded successfully");
        }, 500);
    </script>
</body>
</html>