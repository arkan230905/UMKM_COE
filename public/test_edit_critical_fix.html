<!DOCTYPE html>
<html>
<head>
    <title>Test Edit Critical Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .debug-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .console-log { background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Test Edit Critical Fix</h1>
        <div class="alert alert-danger">
            <strong>CRITICAL ISSUE:</strong><br>
            Edit page shows data but totals are "Rp 0" because JavaScript doesn't initialize existing data properly.
        </div>
        
        <div class="debug-section">
            <h3>Simulated Edit Page Problem</h3>
            <div class="alert alert-info">
                <strong>Problem Description:</strong><br>
                - Bahan Baku shows "Rp 32,000" but no quantity visible<br>
                - Bahan Pendukung shows "Rp 28,000" and "Rp 20,000" but no quantities<br>
                - All totals show "Rp 0" instead of actual values<br>
                - No conversion formulas displaying
            </div>
            
            <table class="table table-sm" id="bahanBakuTable">
                <thead style="background-color: #9f7aea; color: white;">
                    <tr>
                        <th>BAHAN BAKU</th>
                        <th>JUMLAH</th>
                        <th>SATUAN</th>
                        <th>HARGA SATUAN</th>
                        <th>SUB TOTAL</th>
                        <th>AKSI</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="form-select form-select-sm bahan-baku-select">
                                <option value="">-- Pilih Bahan Baku --</option>
                                <option value="3" 
                                        data-harga="32000" 
                                        data-satuan="Kilogram" 
                                        data-sub-satuan='[{"id":4,"nama":"Gram","konversi":"1.0000","nilai":"1000.0000"},{"id":6,"nama":"Ons","konversi":"1.0000","nilai":"10.0000"}]'
                                        selected>
                                    Ayam Potong - Rp 32,000/Kilogram
                                </option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm qty-input text-center" value="1" step="0.01" min="0">
                        </td>
                        <td>
                            <select class="form-select form-select-sm satuan-select">
                                <option value="">-- Satuan --</option>
                                <option value="Kilogram" selected>Kilogram</option>
                                <option value="Gram">Gram</option>
                                <option value="Ons">Ons</option>
                            </select>
                        </td>
                        <td class="text-end harga-display">
                            <div class="harga-utama">Rp 32,000</div>
                            <div class="harga-konversi mt-1" style="font-size: 0.75rem; color: #666;"></div>
                        </td>
                        <td class="text-end subtotal-display">
                            <strong>Rp 32,000</strong>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
                <tfoot style="background-color: #fef3c7;">
                    <tr>
                        <th colspan="4" class="text-end">Total BBB</th>
                        <th class="text-end" id="totalBahanBaku">Rp 0</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
            
            <table class="table table-sm" id="bahanPendukungTable">
                <thead style="background-color: #22d3ee; color: white;">
                    <tr>
                        <th>BAHAN PENOLONG</th>
                        <th>JUMLAH</th>
                        <th>SATUAN</th>
                        <th>HARGA SATUAN</th>
                        <th>SUB TOTAL</th>
                        <th>AKSI</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="form-select form-select-sm bahan-pendukung-select">
                                <option value="">-- Pilih Bahan Pendukung --</option>
                                <option value="3" 
                                        data-harga="28000" 
                                        data-satuan="Kilogram" 
                                        data-sub-satuan='[{"id":4,"nama":"Gram","konversi":"1.0000","nilai":"1000.0000"},{"id":6,"nama":"Ons","konversi":"1.0000","nilai":"10.0000"},{"id":8,"nama":"Siung","konversi":"1.0000","nilai":"250.0000"}]'
                                        selected>
                                    Bawang Putih - Rp 28,000/Kilogram
                                </option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm qty-input text-center" value="1" step="0.01" min="0">
                        </td>
                        <td>
                            <select class="form-select form-select-sm satuan-select">
                                <option value="">-- Satuan --</option>
                                <option value="Kilogram" selected>Kilogram</option>
                                <option value="Gram">Gram</option>
                                <option value="Ons">Ons</option>
                                <option value="Siung">Siung</option>
                            </select>
                        </td>
                        <td class="text-end harga-display">
                            <div class="harga-utama">Rp 28,000</div>
                            <div class="harga-konversi mt-1" style="font-size: 0.75rem; color: #666;"></div>
                        </td>
                        <td class="text-end subtotal-display">
                            <strong>Rp 28,000</strong>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <select class="form-select form-select-sm bahan-pendukung-select">
                                <option value="">-- Pilih Bahan Pendukung --</option>
                                <option value="6" 
                                        data-harga="2000" 
                                        data-satuan="Pieces" 
                                        data-sub-satuan='[]'
                                        selected>
                                    Kemasan - Rp 2,000/Pieces
                                </option>
                            </select>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm qty-input text-center" value="10" step="0.01" min="0">
                        </td>
                        <td>
                            <select class="form-select form-select-sm satuan-select">
                                <option value="">-- Satuan --</option>
                                <option value="Pieces" selected>Pieces</option>
                            </select>
                        </td>
                        <td class="text-end harga-display">
                            <div class="harga-utama">Rp 2,000</div>
                            <div class="harga-konversi mt-1" style="font-size: 0.75rem; color: #666;"></div>
                        </td>
                        <td class="text-end subtotal-display">
                            <strong>Rp 20,000</strong>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
                <tfoot style="background-color: #cffafe;">
                    <tr>
                        <th colspan="4" class="text-end">Total Bahan Pendukung</th>
                        <th class="text-end" id="totalBahanPendukung">Rp 0</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
            
            <div class="mt-3">
                <h5>Summary:</h5>
                <div>Total Biaya Bahan: <span id="summaryTotalBiaya" class="text-success">Rp 0</span></div>
                <div>BBB: <span id="summaryBahanBaku">Rp 0</span> | Bahan Pendukung: <span id="summaryBahanPendukung">Rp 0</span></div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-success" onclick="forceEditInitialization()">üîÑ Force Edit Initialization</button>
                <button class="btn btn-warning" onclick="testConversions()">üß™ Test Conversions</button>
                <button class="btn btn-danger" onclick="emergencyDebug()">üö® Emergency Debug</button>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>Console Logs:</h3>
            <div id="consoleLogs" class="console-log"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        // [JavaScript will be added via append]
    </script>
</body>
</html>
        // Capture console logs
        const originalLog = console.log;
        const logContainer = document.getElementById('consoleLogs');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = args.join(' ') + '\n';
            logContainer.textContent += new Date().toLocaleTimeString() + ': ' + logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        // Same functions as edit page (critical fix versions)
        function formatClean(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            return num === Math.floor(num) ? Math.floor(num).toString() : parseFloat(num.toFixed(4)).toString();
        }
        
        function formatRupiah(num) {
            if (typeof num === 'string') {
                num = parseFloat(num);
            }
            return "Rp " + Math.round(num).toLocaleString("id-ID");
        }
        
        function updateConversionDisplay(row, option) {
            console.log("üìä updateConversionDisplay called");
            
            const hargaKonversiDiv = row.querySelector(".harga-konversi");
            const satuanSelect = row.querySelector(".satuan-select");
            
            if (!hargaKonversiDiv || !option || !satuanSelect) {
                console.log("‚ùå Missing elements");
                return;
            }
            
            const hargaUtama = parseFloat(option.dataset.harga) || 0;
            const satuanUtama = option.dataset.satuan || "unit";
            const satuanDipilih = satuanSelect.value;
            
            let subSatuanData = [];
            try {
                const rawData = option.dataset.subSatuan || "[]";
                subSatuanData = JSON.parse(rawData);
                console.log("üìã Parsed sub satuan data:", subSatuanData);
            } catch (e) {
                console.error("‚ùå Error parsing sub satuan data:", e);
                subSatuanData = [];
            }
            
            console.log("üìã Data:", {
                harga: hargaUtama,
                satuanUtama: satuanUtama,
                satuanDipilih: satuanDipilih,
                subSatuanCount: subSatuanData.length
            });
            
            if (!satuanDipilih) {
                hargaKonversiDiv.innerHTML = '<small class="text-muted">Pilih satuan untuk konversi</small>';
                return;
            }
            
            if (subSatuanData.length > 0) {
                console.log("‚úÖ Using database sub satuan");
                
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === satuanDipilih.toLowerCase().trim()
                );
                
                if (match) {
                    const konversi = parseFloat(match.konversi) || 1;
                    const nilai = parseFloat(match.nilai) || 1;
                    const hargaKonversi = (hargaUtama * konversi) / nilai;
                    const konversiClean = formatClean(konversi);
                    const nilaiClean = formatClean(nilai);
                    
                    console.log("üéØ Found match:", {
                        match: match,
                        konversi: konversi,
                        nilai: nilai,
                        hargaKonversi: hargaKonversi
                    });
                    
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-info mb-2">
                            <strong>${formatRupiah(hargaKonversi)}/${satuanDipilih}</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.85rem; line-height: 1.3;">
                            <div class="fw-bold text-primary mb-1">üìä Rumus:</div>
                            <div>‚Ä¢ ${konversiClean} ${satuanUtama} = ${nilaiClean} ${satuanDipilih}</div>
                            <div>‚Ä¢ ${formatRupiah(hargaUtama)} √ó ${konversiClean} √∑ ${nilaiClean}</div>
                            <div class="text-success fw-bold">‚Ä¢ = ${formatRupiah(hargaKonversi)}</div>
                        </div>
                    `;
                    return;
                }
                
                if (satuanDipilih === satuanUtama) {
                    console.log("üìã Same unit - showing all conversions");
                    
                    let html = '<div class="text-success mb-2"><strong>Satuan sama, tidak perlu konversi</strong></div>';
                    html += '<div class="text-muted mb-2"><strong>Konversi Tersedia:</strong></div>';
                    
                    subSatuanData.forEach(sub => {
                        const konversi = parseFloat(sub.konversi) || 1;
                        const nilai = parseFloat(sub.nilai) || 1;
                        const hargaKonversi = (hargaUtama * konversi) / nilai;
                        const konversiClean = formatClean(konversi);
                        const nilaiClean = formatClean(nilai);
                        
                        html += `
                            <div class="border-start border-info ps-2 mb-1" style="font-size: 0.8rem;">
                                <div class="text-info"><strong>${formatRupiah(hargaKonversi)}/${sub.nama}</strong></div>
                                <div class="text-muted">${konversiClean} ${satuanUtama} = ${nilaiClean} ${sub.nama}</div>
                            </div>
                        `;
                    });
                    
                    hargaKonversiDiv.innerHTML = html;
                    return;
                } else {
                    console.log("‚ö†Ô∏è No conversion match found");
                    hargaKonversiDiv.innerHTML = `
                        <div class="text-warning mb-1">Konversi tidak ditemukan</div>
                        <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                    `;
                    return;
                }
            }
            
            if (satuanDipilih === satuanUtama) {
                hargaKonversiDiv.innerHTML = `
                    <div class="text-success mb-1">
                        <strong>${formatRupiah(hargaUtama)}/${satuanUtama}</strong>
                    </div>
                    <small class="text-muted">Satuan sama, tidak perlu konversi</small>
                `;
            } else {
                hargaKonversiDiv.innerHTML = `
                    <div class="text-warning">Konversi tidak tersedia</div>
                    <small class="text-muted">Dari ${satuanUtama} ke ${satuanDipilih}</small>
                `;
            }
        }
        
        function getConversionFactor(fromUnit, toUnit, subSatuanData = []) {
            if (fromUnit.toLowerCase() === toUnit.toLowerCase()) {
                return 1;
            }
            
            if (subSatuanData.length > 0) {
                const match = subSatuanData.find(sub => 
                    sub.nama.toLowerCase().trim() === toUnit.toLowerCase().trim()
                );
                
                if (match) {
                    const konversi = parseFloat(match.konversi) || 1;
                    const nilai = parseFloat(match.nilai) || 1;
                    return konversi / nilai;
                }
            }
            
            return 1;
        }
        
        function calculateRowSubtotal(row) {
            console.log("üßÆ calculateRowSubtotal called (CRITICAL FIX)");
            
            const bahanSelect = row.querySelector(".bahan-baku-select, .bahan-pendukung-select");
            const qtyInput = row.querySelector(".qty-input");
            const satuanSelect = row.querySelector(".satuan-select");
            const subtotalDisplay = row.querySelector(".subtotal-display");
            
            if (!bahanSelect || !qtyInput || !satuanSelect || !subtotalDisplay) {
                console.log("‚ùå Missing elements for calculation");
                return;
            }
            
            const option = bahanSelect.options[bahanSelect.selectedIndex];
            if (!option || !option.value) {
                subtotalDisplay.innerHTML = "-";
                return;
            }
            
            const harga = parseFloat(option.dataset.harga) || 0;
            const qty = parseFloat(qtyInput.value) || 0;
            const satuanUtama = option.dataset.satuan || "unit";
            const satuanDipilih = satuanSelect.value;
            
            let subSatuanData = [];
            try {
                subSatuanData = JSON.parse(option.dataset.subSatuan || "[]");
            } catch (e) {
                console.error("‚ùå Error parsing sub satuan for calculation:", e);
                subSatuanData = [];
            }
            
            console.log("üí∞ CRITICAL FIX Calculation data:", {
                bahan: option.text,
                harga: harga,
                qty: qty,
                satuanUtama: satuanUtama,
                satuanDipilih: satuanDipilih,
                subSatuanCount: subSatuanData.length,
                currentSubtotal: subtotalDisplay.textContent
            });
            
            if (qty <= 0 || !satuanDipilih) {
                subtotalDisplay.innerHTML = "-";
                return;
            }
            
            let subtotal = harga * qty;
            
            if (satuanUtama !== satuanDipilih) {
                const factor = getConversionFactor(satuanUtama, satuanDipilih, subSatuanData);
                subtotal = (harga * factor) * qty;
                console.log("üîÑ Applied conversion factor:", factor, "New subtotal:", subtotal);
            }
            
            // CRITICAL: Always update the display
            subtotalDisplay.innerHTML = `<strong class="text-success">${formatRupiah(subtotal)}</strong>`;
            console.log("‚úÖ CRITICAL FIX Subtotal updated:", subtotal, "for", option.text);
        }
        
        function calculateTotals() {
            console.log("üìä === CALCULATING TOTALS (CRITICAL FIX) ===");
            
            let totalBB = 0;
            let totalBP = 0;
            let debugInfo = [];
            
            // Bahan Baku
            const bbRows = document.querySelectorAll("#bahanBakuTable tbody tr");
            debugInfo.push(`Found ${bbRows.length} BB rows`);
            
            bbRows.forEach((row, index) => {
                const subtotalDisplay = row.querySelector(".subtotal-display");
                let subtotal = 0;
                
                if (subtotalDisplay) {
                    const subtotalText = subtotalDisplay.textContent || subtotalDisplay.innerText || "";
                    
                    if (subtotalText.includes("Rp")) {
                        const cleanText = subtotalText.replace(/[^\d]/g, "");
                        subtotal = parseFloat(cleanText) || 0;
                    } else if (subtotalText.trim() !== "-" && subtotalText.trim() !== "") {
                        const cleanText = subtotalText.replace(/[^\d.]/g, "");
                        subtotal = parseFloat(cleanText) || 0;
                    }
                }
                
                const bahanSelect = row.querySelector(".bahan-baku-select");
                const bahanName = bahanSelect?.options[bahanSelect.selectedIndex]?.text || 'Unknown';
                
                debugInfo.push(`BB Row ${index}: ${bahanName} = ${subtotal} (text: "${subtotalText}")`);
                totalBB += subtotal;
            });
            
            // Bahan Pendukung
            const bpRows = document.querySelectorAll("#bahanPendukungTable tbody tr");
            debugInfo.push(`Found ${bpRows.length} BP rows`);
            
            bpRows.forEach((row, index) => {
                const subtotalDisplay = row.querySelector(".subtotal-display");
                let subtotal = 0;
                
                if (subtotalDisplay) {
                    const subtotalText = subtotalDisplay.textContent || subtotalDisplay.innerText || "";
                    
                    if (subtotalText.includes("Rp")) {
                        const cleanText = subtotalText.replace(/[^\d]/g, "");
                        subtotal = parseFloat(cleanText) || 0;
                    } else if (subtotalText.trim() !== "-" && subtotalText.trim() !== "") {
                        const cleanText = subtotalText.replace(/[^\d.]/g, "");
                        subtotal = parseFloat(cleanText) || 0;
                    }
                }
                
                const bahanSelect = row.querySelector(".bahan-pendukung-select");
                const bahanName = bahanSelect?.options[bahanSelect.selectedIndex]?.text || 'Unknown';
                
                debugInfo.push(`BP Row ${index}: ${bahanName} = ${subtotal} (text: "${subtotalText}")`);
                totalBP += subtotal;
            });
            
            const total = totalBB + totalBP;
            
            console.log("üìä CRITICAL FIX TOTALS:", { 
                bb: totalBB, 
                bp: totalBP, 
                total: total,
                debug: debugInfo
            });
            
            // Update displays
            const elements = {
                totalBahanBaku: document.getElementById("totalBahanBaku"),
                totalBahanPendukung: document.getElementById("totalBahanPendukung"),
                summaryBahanBaku: document.getElementById("summaryBahanBaku"),
                summaryBahanPendukung: document.getElementById("summaryBahanPendukung"),
                summaryTotalBiaya: document.getElementById("summaryTotalBiaya")
            };
            
            if (elements.totalBahanBaku) {
                elements.totalBahanBaku.textContent = formatRupiah(totalBB);
                console.log("‚úÖ Updated totalBahanBaku:", formatRupiah(totalBB));
            }
            if (elements.totalBahanPendukung) {
                elements.totalBahanPendukung.textContent = formatRupiah(totalBP);
                console.log("‚úÖ Updated totalBahanPendukung:", formatRupiah(totalBP));
            }
            if (elements.summaryBahanBaku) {
                elements.summaryBahanBaku.textContent = formatRupiah(totalBB);
                console.log("‚úÖ Updated summaryBahanBaku:", formatRupiah(totalBB));
            }
            if (elements.summaryBahanPendukung) {
                elements.summaryBahanPendukung.textContent = formatRupiah(totalBP);
                console.log("‚úÖ Updated summaryBahanPendukung:", formatRupiah(totalBP));
            }
            if (elements.summaryTotalBiaya) {
                elements.summaryTotalBiaya.textContent = formatRupiah(total);
                console.log("‚úÖ Updated summaryTotalBiaya:", formatRupiah(total));
            }
            
            console.log("üìä === CRITICAL FIX TOTALS UPDATE COMPLETE ===");
        }
        
        // CRITICAL FIX: Force initialization function
        function forceEditInitialization() {
            console.log("üö® CRITICAL FIX: FORCE EDIT INITIALIZATION");
            
            let processed = 0;
            
            // Find all rows with data
            const allRows = document.querySelectorAll("#bahanBakuTable tbody tr, #bahanPendukungTable tbody tr");
            
            allRows.forEach((row, index) => {
                const bahanSelect = row.querySelector(".bahan-baku-select, .bahan-pendukung-select");
                const qtyInput = row.querySelector(".qty-input");
                const satuanSelect = row.querySelector(".satuan-select");
                
                if (bahanSelect && bahanSelect.value && qtyInput && qtyInput.value && satuanSelect && satuanSelect.value) {
                    console.log(`üîÑ CRITICAL FIX: Force processing row ${index}:`, {
                        bahan: bahanSelect.value,
                        qty: qtyInput.value,
                        satuan: satuanSelect.value
                    });
                    
                    const option = bahanSelect.options[bahanSelect.selectedIndex];
                    if (option && option.dataset.harga) {
                        // Force update harga display
                        const hargaDisplay = row.querySelector(".harga-utama");
                        if (hargaDisplay) {
                            const harga = parseInt(option.dataset.harga);
                            hargaDisplay.innerHTML = `<strong>${formatRupiah(harga)}</strong>`;
                        }
                        
                        // Force conversion display
                        updateConversionDisplay(row, option);
                        
                        // Force subtotal calculation
                        calculateRowSubtotal(row);
                        
                        processed++;
                    }
                }
            });
            
            console.log(`‚úÖ CRITICAL FIX: Force processed ${processed} rows`);
            
            // Force totals calculation
            setTimeout(() => {
                calculateTotals();
                console.log("‚úÖ CRITICAL FIX: Force totals calculation completed");
            }, 200);
        }
        
        function testConversions() {
            console.log("üß™ Testing conversions...");
            
            // Change first row to Gram
            const firstBBSatuan = document.querySelector("#bahanBakuTable .satuan-select");
            if (firstBBSatuan) {
                firstBBSatuan.value = 'Gram';
                const row = firstBBSatuan.closest('tr');
                const bahanSelect = row.querySelector('.bahan-baku-select');
                const option = bahanSelect.options[bahanSelect.selectedIndex];
                updateConversionDisplay(row, option);
                calculateRowSubtotal(row);
            }
            
            // Change first BP row to Siung
            const firstBPSatuan = document.querySelector("#bahanPendukungTable .satuan-select");
            if (firstBPSatuan) {
                firstBPSatuan.value = 'Siung';
                const row = firstBPSatuan.closest('tr');
                const bahanSelect = row.querySelector('.bahan-pendukung-select');
                const option = bahanSelect.options[bahanSelect.selectedIndex];
                updateConversionDisplay(row, option);
                calculateRowSubtotal(row);
            }
            
            console.log("‚úÖ Conversion tests completed");
        }
        
        function emergencyDebug() {
            console.log("üö® EMERGENCY DEBUG - CRITICAL FIX");
            
            let info = [];
            info.push("=== CRITICAL FIX DEBUG ===");
            
            const allRows = document.querySelectorAll("#bahanBakuTable tbody tr, #bahanPendukungTable tbody tr");
            info.push(`Total rows found: ${allRows.length}`);
            
            allRows.forEach((row, index) => {
                const bahanSelect = row.querySelector(".bahan-baku-select, .bahan-pendukung-select");
                const qtyInput = row.querySelector(".qty-input");
                const satuanSelect = row.querySelector(".satuan-select");
                const subtotalDisplay = row.querySelector(".subtotal-display");
                
                info.push(`Row ${index}:`);
                info.push(`  Bahan: ${bahanSelect?.value || 'none'}`);
                info.push(`  Qty: ${qtyInput?.value || 'none'}`);
                info.push(`  Satuan: ${satuanSelect?.value || 'none'}`);
                info.push(`  Subtotal: ${subtotalDisplay?.textContent || 'none'}`);
                
                if (bahanSelect && bahanSelect.value) {
                    const option = bahanSelect.options[bahanSelect.selectedIndex];
                    info.push(`  Harga data: ${option?.dataset?.harga || 'missing'}`);
                    info.push(`  Sub satuan: ${option?.dataset?.subSatuan ? 'available' : 'missing'}`);
                }
            });
            
            // Force recalculation
            info.push("=== FORCING RECALCULATION ===");
            forceEditInitialization();
            info.push("Force initialization triggered");
            
            console.log("üö® CRITICAL FIX DEBUG INFO:", info);
        }
        
        function clearLogs() {
            document.getElementById('consoleLogs').textContent = '';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üéâ Critical Fix Test page loaded");
            
            // Show initial problem state
            console.log("‚ùå PROBLEM: Totals showing Rp 0 despite having data");
            console.log("üîç Initial state check...");
            
            const allRows = document.querySelectorAll("#bahanBakuTable tbody tr, #bahanPendukungTable tbody tr");
            allRows.forEach((row, index) => {
                const bahanSelect = row.querySelector(".bahan-baku-select, .bahan-pendukung-select");
                const qtyInput = row.querySelector(".qty-input");
                const satuanSelect = row.querySelector(".satuan-select");
                const subtotalDisplay = row.querySelector(".subtotal-display");
                
                console.log(`Row ${index}: bahan=${bahanSelect?.value}, qty=${qtyInput?.value}, satuan=${satuanSelect?.value}, subtotal=${subtotalDisplay?.textContent}`);
            });
            
            // Auto-run force initialization after delay
            setTimeout(() => {
                console.log("üîÑ Auto-running force initialization...");
                forceEditInitialization();
            }, 1000);
        });